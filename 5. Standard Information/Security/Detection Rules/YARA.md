`YARA (Yet Another Recursive Acronym)`, a widely used open-source pattern matching tool and rule-based malware detection and classification framework let's us create custom rules to spot specific patterns or characteristics in files, processes, or memory. To draft a `YARA` rule for our sample, we'll need to examine the behaviour, features, or specific strings/patterns unique to the sample we aim to detect.

Here's a simple example of a `YARA` rule that matches the presence of the string `Sandbox detected` in a process.

```yara
rule Shell_Sandbox_Detection {
    strings:
        $sandbox_string = "Sandbox detected"
    condition:
        $sandbox_string
}
```
## Detecting Malware Using Yara Rules

We can then use this rule to scan a directory as follows.

```shell-session
yara rules.yar /home/htb-student/Samples/MalwareAnalysis/
```

## YARA Documentation

- Yara documentation : [https://yara.readthedocs.io/en/stable/writingrules.html](https://yara.readthedocs.io/en/stable/writingrules.html)
- Yara resources - [https://github.com/InQuest/awesome-yara](https://github.com/InQuest/awesome-yara)
- The DFIR Report - [https://github.com/The-DFIR-Report/Yara-Rules](https://github.com/The-DFIR-Report/Yara-Rules)

# Generation Tooling

## yarGen

 A tool which automates the process of generating `YARA` rules, with the prime objective of crafting the best possible rules for manual post-processing. This, however, necessitates a shrewd automatic preselection and a discerning human analyst to generate a robust rule.

To automatically create a Yara rule for `shell.exe` we should execute the following (inside the `/home/htb-student/yarGen-0.23.4` directory):

```shell-session
sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/MalwareHere/
```


`yargen_rule.yar` is generated by `yarGen` that incorporates unique strings, which are automatically extracted and inserted into the rule.

```yara
rule _home_htb_student_Samples_MalwareAnalysis_Test_shell {
   meta:
      description = "Test - file shell.exe"
      author = "yarGen Rule Generator"
      reference = "https://github.com/Neo23x0/yarGen"
      date = "2023-08-02"
      hash1 = "bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"
   strings:
      $x1 = "C:\\Windows\\System32\\cmd.exe" fullword ascii
      $s2 = "http://ms-windows-update.com/svchost.exe" fullword ascii
      $s3 = "C:\\Windows\\System32\\notepad.exe" fullword ascii
      $s4 = "/k ping 127.0.0.1 -n 5" fullword ascii
      $s5 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" fullword ascii
      $s6 = "  VirtualQuery failed for %d bytes at address %p" fullword ascii
      $s7 = "[-] Error code is : %lu" fullword ascii
      $s8 = "C:\\Program Files\\VMware\\VMware Tools\\" fullword ascii
      $s9 = "Failed to open the registry key." fullword asciiquadrantChart
		title Reach and engagement of campaigns
		x-axis Low Reach --> High Reach
		y-axis Low Engagement --> High Engagement
		quadrant-1 We should expand
		quadrant-2 Need to promote
		quadrant-3 Re-evaluate
		quadrant-4 May be improved
		Campaign A: [0.3, 0.6]
		Campaign B: [0.45, 0.23]
		Campaign C: [0.57, 0.69]
		Campaign D: [0.78, 0.34]
		Campaign E: [0.40, 0.34]
		Campaign F: [0.35, 0.78]

      $s10 = "  VirtualProtect failed with code 0x%x" fullword ascii
      $s11 = "Connection sent to C2" fullword ascii
      $s12 = "VPAPAPAPI" fullword ascii
      $s13 = "AWAVAUATVSH" fullword ascii
      $s14 = "45.33.32.156" fullword ascii
      $s15 = "  Unknown pseudo relocation protocol version %d." fullword ascii
      $s16 = "AQAPRQVH1" fullword ascii
      $s17 = "connect" fullword ascii /* Goodware String - occured 429 times */
      $s18 = "socket" fullword ascii /* Goodware String - occured 452 times */
      $s19 = "tSIcK<L" fullword ascii
      $s20 = "Windows-Update/7.6.7600.256 %s" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 60KB and
      1 of ($x*) and 4 of them
}
```
