See [[5. Standard Information/Operating Systems/Android/Packages/1. Overview|APK]]

See [[Smali]] or [[Jadx]] for decompaction 

# Reverse Engineering APKs: Comprehensive Analysis and Techniques

## 1. Introduction
- This guide focuses on analyzing Android APKs, reverse engineering them, and understanding malicious behavior.
- The case study centers on **SARA.apk**, a ransomware application that locks devices and demands Bitcoin payments.

---

## 2. APK Engineering Process
1. **Java Compilation**:
   - Java/Kotlin source code is compiled into Java bytecode.
   - Bytecode is stored in `.class` files, executable by any Java Virtual Machine (JVM).

2. **Android Compilation**:
   - The Android SDK's **DEX Compiler** converts `.class` files into Dalvik Executable (`.dex`) format.
   - `.dex` files are optimized for Android's runtime environment.

3. **Packaging**:
   - Resources like layouts, images, and compiled `.dex` files are bundled into an APK (Android Package).
   - APKs are signed with a digital certificate for integrity and authenticity verification.

---

## 3. Target SDK Information Extraction
- **Command**: `aapt dump badging SARA.apk | grep "target SDK version"`
- Results:
  - **Target SDK Version**: 21.
  - **Minimum SDK Requirement**: 23 for Android 14+.
- Installation Block:
  - Attempting to install with `adb install` results in an error due to low target SDK version.
  - **Bypass**: Add `--bypass-low-target-sdk-block` to override restrictions.

---

## 4. Unpacking the APK
### Unzipping the APK
- Use `unzip SARA.apk` to extract its contents.
- Key Components:
  1. **classes.dex**: Dalvik executable containing compiled code.
  2. **AndroidManifest.xml**: Application metadata and permissions.
  3. **res/ folder**: Resources like UI layouts (`main.xml`) and images.
  4. **META-INF folder**: Digital certificates and signature metadata.

### Verifying Integrity
- Certificates in META-INF are used by Android to check APK authenticity.
- If tampered with, re-signing the APK is mandatory.

---

## 5. Toolset for Reverse Engineering
1. **APK Tool**:
   - Decodes APKs into Smalley code (human-readable Dalvik bytecode).
   - Allows resource modification, such as layouts or manifest files.
   - Command: `apktool d SARA.apk -o output-folder`

2. **Jadx GUI**:
   - Converts `.dex` files into readable Java code.
   - Features:
     - Class and text search.
     - Deobfuscation support.
     - Integration with Quark Engine for vulnerability analysis.

---

## 6. Malware Analysis: SARA.apk
### Initial Observations
- **Behavior**:
  - Displays a ransom note demanding Bitcoin payment.
  - Locks user interaction through overlays.
  - Prevents task switching or application exits.

### AndroidManifest.xml Insights
1. **Permissions**:
   - Example: `android.permission.RECEIVE_BOOT_COMPLETED` ensures malware runs after device reboots.
   - Other suspicious permissions:
     - `READ_CONTACTS`: Accesses user contacts.
     - `READ_SMS`: Reads incoming text messages.
     - `SYSTEM_ALERT_WINDOW`: Displays overlays on top of all apps.

2. **Activity Entry Point**:
   - The `main` activity is marked with `launcher` and `main` categories.
   - This activity initializes the malware's lock screen.

---

## 7. Reverse Engineering Smalley Code
### Smalley Code Overview
- **Registers**:
  1. `v` Registers: Local, temporary storage within methods.
  2. `p` Registers: Parameters passed to methods.
- **Instruction Types**:
  - `const-string`: Loads constant strings.
  - `invoke-virtual`: Calls instance methods.
  - `sget`: Retrieves static fields.

### Analysis Workflow
1. **Unpack APK**:
   - Extract `.dex` files and decompile into Smalley using APK Tool.
2. **Examine AndroidManifest.xml**:
   - Identify permissions and entry points.
3. **Trace Smalley Code**:
   - Locate and analyze suspicious methods.

---

## 8. Obfuscation Techniques Used
1. **Identifier Remapping**:
   - Replaces meaningful names with generic identifiers (e.g., `A`, `B`).
2. **White Noise**:
   - Adds redundant code to hinder readability.
   - Example: Creating unnecessary objects or methods.
3. **Literal Encryption**:
   - Encrypts sensitive data like strings and decrypts them at runtime.
4. **Reflection**:
   - Dynamically invokes methods, making it harder to trace logic.
5. **Packers**:
   - Compress or encrypt the app's code, dynamically unpacked during runtime.

---

## 9. Advanced Tools for Deobfuscation
1. **Simplify**:
   - Automates deobfuscation via Smalley VM.
   - Removes dead code, unreflects methods, and performs constant propagation.
   - Usage:
     ```bash
     java -jar simplify.jar -it <target-class> -o output.apk
     ```
   - Allows targeting specific classes or functions.

2. **Quark Engine**:
   - Integrated in Jadx GUI.
   - Detects vulnerabilities and malicious behaviors in Android apps.

---

## 10. Detailed SARA Malware Behavior
### Functionality Analysis
1. **Main Activity**:
   - Launches the malware overlay using `WindowManager`.
   - Locks the screen with an inflated layout.
   - Requires a specific PIN ("hack binaries in reverse") to unlock.

2. **Service Initialization**:
   - Declared in `AndroidManifest.xml`.
   - Executes malware persistence using `RECEIVE_BOOT_COMPLETED`.

3. **Overlay Lock Screen**:
   - `WindowManager.LayoutParams.TYPE_PHONE` places the overlay above all apps.
   - Prevents user interaction and task switching.

### Security Evasion
- Targets older SDKs (21) to bypass modern permission requirements.
- Uses obfuscation techniques like identifier remapping and white noise.

---

## 11. Recommendations
1. **Safe Malware Analysis**:
   - Use virtual devices or emulators.
   - Never run malicious APKs on personal devices.
2. **Tool Utilization**:
   - Combine tools like APK Tool, Jadx GUI, and Simplify for detailed analysis.
3. **Documentation Reference**:
   - Use Android Developer Documentation for permission insights.

---

## 12. Conclusion
- The reverse engineering process involves understanding APK structures, permissions, and code execution flow.
- SARA.apk illustrates how malware exploits Android systems using obfuscation and SDK-specific vulnerabilities.
- Tools like Simplify and Jadx GUI streamline analysis and enhance understanding of malware behavior.
