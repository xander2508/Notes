---
tags:
  - Exploitation
  - FileTypesAndData
  - Malware
  - MalwareProgramsandExecutables
  - StaticAnalysis
  - Tooling
  - Debugging
  - FileTypesandData
---

Here's how to run a sample within `x64dbg` to familiarize with its operations.
- Launch `x64dbg`.
- At the top of the `x64dbg` interface, click the `File` menu.
- Select `Open` to choose the executable file we wish to debug.
- Browse to the directory containing the executable and select it.
- Optionally, command-line arguments or the working directory can be specified in the dialog box that appears.
- Click `OK` to load the executable into `x64dbg`.

## Applying the Patches to Bypass Sandbox Checks

Given that sandbox checks hinder the malware's direct execution on the machine, we need to patch these checks to circumvent the sandbox detection. Here's how we can dodge sandbox detection checks while debugging with `x64dbg`. Several methods can lead us to the instructions where sandbox detection is performed. We will discuss a few of these.

### By Copying the Address from IDA

During code analysis, we observed the sandbox detection check related to the registry key. We can extract the address of the first `cmp` instruction directly from `IDA`.

To find the address, let's revert to the IDA windows, open the first function we had renamed as `assumed_Main`, and look for the `cmp` instruction. To view the addresses, we can transition from graph view to text view by pressing the spacebar button.

This exposes the address (as highlighted in the below screenshot)

We can copy the address `00000000004032C8` from `IDA`.

Code: ida

```ida
.text:00000000004032C8                 cmp     [rsp+148h+Type], 1
```

In `x64dbg`, we can right-click anywhere on the disassembly view (CPU) and select `Go to` > `Expression`. Alternatively, we can press `Ctrl+G` (go to expression) as a shortcut.

We can enter the copied address here, as shown in the screenshot. This navigates us to the comparison instruction where we can implement changes.

![Image](https://academy.hackthebox.com/storage/modules/227/ida_027_addresscp.png)

### By Searching Through the Strings.

Let's look for `Sandbox detected` in the `String references`, and set a `breakpoint`, so that when we hit run, the execution should pause at this point.

To do this, first click on the `Run` button once and then right-click anywhere on the disassembly view, and choose `Search for` > `Current Module` > `String references`.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_002_strings_.png)

Next, we can add a breakpoint to mark the location, then study the instructions before this Sandbox `MessageBox` to discern how the jump was made to the instruction printing `Sandbox detected`.

Let's start by adding a breakpoint at the last `Sandbox detected` string as follows.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_002_strings__.png)

We can then double-click on the string to go to the address where the instructions to print `Sandbox detected` are located.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_003_cmp.png)

As observed, a `cmp` instruction is present above this `MessageBox` which compares the value with `1` after a registry path comparison has been performed. Let's modify this comparison value to match with `0` instead. This can be done by placing the cursor on that instruction and pressing `Spacebar` on the keyboard. This allows us to edit the assembly code instructions.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_004_assemble_patch1.png)

We can change the comparison value of `0x1` to `0x0`. Changing the comparison to `0` may shift the control flow of the code, and it should not jump to the address where `MessageBox` is displayed.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_004_patch1.png)

Upon clicking on `Run` in `x64dbg` or pressing `F9`, it won't hit the breakpoint for the first sandbox detection message code. This means that we successfully patched the instructions.

In a similar manner, we can add a breakpoint on the next sandbox detection function before it prints a `MessageBox` as well. To do that, the breakpoint should be placed at the `second to last` `Sandbox detected` string (`0000000000402F13`). If we double-click this string we will notice there's a `jump` instruction which we can skip, directing the execution flow to the next instruction that calls another function. That's exactly what we need – instead of the sandbox detection `MessageBox`, it jumps to another function.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_005_patch2.png)

We can alter the instruction from `je shell.402F09` to `jne shell.402F09`.

![Image](https://academy.hackthebox.com/storage/modules/227/x64dbg_006_jne.png)

`shell.exe` performs sandbox detection by checking for internet connectivity. This section's target doesn't have internet connectivity. For this reason we should patch this sandbox detection method as well. We can do that by clicking on the first `Sandbox detected` string (`0000000000402CBD`) and patching the following instruction.

![Image](https://academy.hackthebox.com/storage/modules/227/patch3.png)

![Image](https://academy.hackthebox.com/storage/modules/227/patch3_.png)

Now, when we press `Run`, the patched `shell.exe` proceeds further, downloads the default executable from `INetSim`, and executes it.

![Image](https://academy.hackthebox.com/storage/modules/227/both_messagebox.png)

With the sandbox checks bypassed, the actual functionality is unveiled. We can save the patched executable by pressing `Ctrl+P` and clicking on `Patch File`. This action stores the patched file, which skips the sandbox checks.

![Image](https://academy.hackthebox.com/storage/modules/227/patch3__.png)

We undertake this process to ensure that the next time we run the saved patched file, it executes directly without the sandbox checks, and we can observe all the events in `ProcessMonitor`.

### Attaching Another Running Process In x64dbg

In order to delve further, let's open another instance of `x64dbg` and attach it to `notepad.exe`.

- Start a new instance of `x64dbg`.
- Navigate to the `File` menu and select `Attach` or use the `Alt + A` keyboard shortcut.
- In the `Attach` dialog box, a list of running processes will appear. Choose `notepad.exe` from the list.
- Click the `Attach` button to begin the attachment process.

Once the attachment is successful, `x64dbg` initiates the debugging of the target process, and the main window displays the assembly code along with other debugging information.

Now, we can establish breakpoints, step through the code, inspect registers and memory, and study the behavior of the attached notepad.exe process using `x64dbg`.