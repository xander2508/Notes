---
tags:
  - Tunnelling
  - Exploitation
---

In the case of ICMP tunnelling an attacker will append data they want to exfiltrate to the outside world or another host in the data field in an ICMP request. This is done with the intention to hide this data among a common protocol type like ICMP, and hopefully get lost within our network traffic.

ICMP tunneling encapsulates your traffic within `ICMP packets` containing `echo requests` and `responses`. ICMP tunneling would only work when ping responses are permitted within a firewalled network. When a host within a firewalled network is allowed to ping an external server, it can encapsulate its traffic within the ping echo request and send it to an external server. The external server can validate this traffic and send an appropriate response, which is extremely useful for data exfiltration and creating pivot tunnels to an external server.

![[Pasted image 20240816161106.jpg]]

## Finding ICMP Tunnelling

Since ICMP tunnelling is primarily done through an attacker adding data into the data field for ICMP, we can find it by looking at the contents of data per request and reply.

![[3-ICMP-tunneling.webp]]

In many cases, if the ICMP data length is larger than 48-bytes, we know something fishy is going on, and should always look into it.

## Preventing ICMP Tunnelling

In order to prevent ICMP tunnelling from occurring we can conduct the following actions.

1. `Block ICMP Requests` - Simply, if ICMP is not allowed, attackers will not be able to utilize it.
    
2. `Inspect ICMP Requests and Replies for Data` - Stripping data, or inspecting data for malicious content on these requests and replies can allow us better insight into our environment, and the ability to prevent this data exfiltration.


## Tooling

[GitHub - utoni/ptunnel-ng: Tunnel TCP connections through ICMP.](https://github.com/utoni/ptunnel-ng)

```shell-session
 git clone https://github.com/utoni/ptunnel-ng.git
```

```shell-session
sudo ./autogen.sh 
```

#### Alternative approach of building a static binary

```shell-session
sudo apt install automake autoconf -y
```

```
cd ptunnel-ng/
```

```
sed -i '$s/.*/LDFLAGS=-static "${NEW_WD}\/configure" --enable-static $@ \&\& make clean \&\& make -j${BUILDJOBS:-4} all/' autogen.sh
```

```
./autogen.sh
```

#### Starting the ptunnel-ng Server on the Target Host

```shell-session
sudo ./ptunnel-ng -r10.129.202.64 -R22
```

The IP address following `-r` should be the IP we want ptunnel-ng to accept connections on. In this case, whatever IP is reachable from our attack host would be what we would use. We would benefit from using this same thinking & consideration during an actual engagement.

Back on the attack host, we can attempt to connect to the ptunnel-ng server (`-p <ipAddressofTarget>`) but ensure this happens through local port 2222 (`-l2222`). Connecting through local port 2222 allows us to send traffic through the ICMP tunnel.

#### Connecting to ptunnel-ng Server from Attack Host

```shell-session
sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22
```

#### Tunnelling an SSH connection through an ICMP Tunnel

With the ptunnel-ng ICMP tunnel successfully established, we can attempt to connect to the target using SSH through local port 2222 (`-p2222`).

```shell-session
ssh -p2222 -lubuntu 127.0.0.1
```

We may also use this tunnel and SSH to perform dynamic port forwarding to allow us to use proxychains in various ways. See [[1. SSH Tunnelling#Enabling Dynamic Port Forwarding with SSH]]







