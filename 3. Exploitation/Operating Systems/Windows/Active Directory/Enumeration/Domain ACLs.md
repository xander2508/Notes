## Access Control Lists (ACLs)

[Access Control List](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) (ACL) settings themselves are called Access Control Entries (ACEs). Each ACE refers back to a user, group, or process (security principal) and defines the principal's rights.

There are two types of ACLs.

|**ACL**|**Description**|
|---|---|
|`Discretionary Access Control List (DACL)`|This defines which security principals are granted or denied access to an object.|
|`System Access Control Lists (SACL)`|These allow administrators to log access attempts made to secured objects.|

ACL (mis)-configurations may allow for chained object-to-object control. We can visualize unrolled membership of target groups, so-called `derivative admins`, who can derive admin rights from exploiting an AD attack chain.

AD Attack chains may include the following components:

- "Unprivileged" users (shadow admins) having administrative access on member servers or workstations.
- Privileged users having a logon session on these workstations and member servers.
- Other forms of object-to-object control include force password change, add group member, change owner, write ACE, and full control.

Below is an example of just some of the ACLs that can be set on a user object.

![[Pasted image 20250121120136.png]]
## ACL Abuse

ACL abuse is a powerful attack vector for us as penetration testers. These types of misconfigurations often go unnoticed in corporate environments because they can be difficult to monitor and control. An organization may be unaware of overly permissive ACL settings for years before (hopefully) we discover them. Below are some of the example Active Directory object security permissions (supported by `BloodHound` and abusable with `SharpView`/`PowerView`):

- ForceChangePassword abused with `Set-DomainUserPassword`
- Add Members abused with `Add-DomainGroupMember`
- GenericAll abused with `Set-DomainUserPassword` or `Add-DomainGroupMember`
- GenericWrite abused with `Set-DomainObject`
- WriteOwner abused with `Set-DomainObjectOwner`
- WriteDACL abused with `Add-DomainObjectACL`
- AllExtendedRights abused with `Set-DomainUserPassword` or `Add-DomainGroupMember`
## Enumerating ACLs with Built-In Cmdlets

We can use the built-in `Get-ADUser` cmdlet to enumerate ACLs. For example, we can look at the ACL for a single domain user `daniel.carter` with this command.

  Enumerating Domain ACLs

```powershell-session
PS C:\htb> (Get-ACL "AD:$((Get-ADUser daniel.carter).distinguishedname)").access  | ? {$_.IdentityReference -eq "INLANEFREIGHT\cliff.moore"}

ActiveDirectoryRights : ReadProperty, WriteProperty, GenericExecute
InheritanceType       : All
ObjectType            : 00000000-0000-0000-0000-000000000000
InheritedObjectType   : 00000000-0000-0000-0000-000000000000
ObjectFlags           : None
AccessControlType     : Allow
IdentityReference     : INLANEFREIGHT\cliff.moore
IsInherited           : False
InheritanceFlags      : ContainerInherit
PropagationFlags      : None

ActiveDirectoryRights : ExtendedRight
InheritanceType       : All
ObjectType            : ab721a53-1e2f-11d0-9819-00aa0040529b
InheritedObjectType   : 00000000-0000-0000-0000-000000000000
ObjectFlags           : ObjectAceTypePresent
AccessControlType     : Allow
IdentityReference     : INLANEFREIGHT\cliff.moore
IsInherited           : False
InheritanceFlags      : ContainerInherit
PropagationFlags      : None
```

We can drill down further on this user to find all users with `WriteProperty` or `GenericAll` rights over the target user.

```powershell-session
(Get-ACL "AD:$((Get-ADUser daniel.carter).distinguishedname)").access  | ? {$_.ActiveDirectoryRights -match "WriteProperty" -or $_.ActiveDirectoryRights -match "GenericAll"} | Select IdentityReference,ActiveDirectoryRights -Unique | ft -W
```

## Enumerating ACLs with PowerView and SharpView

We can use [[PowerView SharpView]] to perform the previous command much quicker. For example, `Get-DomainObjectACL` can be used on a user to return similar data.

```powershell-session
 Get-DomainObjectAcl -Identity harry.jones -Domain inlanefreight.local -ResolveGUIDs
```

We can seek out ACLs on specific users and filter out results using the various AD filters covered in the `Active Directory LDAP` module. We can use the `Find-InterestingDomainAcl` to search out objects in the domain with modification rights over non-built-in objects. This command, too, produces a large amount of data and can either be filtered on for information about specific objects or saved to be examined offline.


```powershell-session
 Find-InterestingDomainAcl -Domain inlanefreight.local -ResolveGUID
```

Aside from users and computers, we should also look at the ACLs set on file shares. This could provide us with information about which users can access a specific share or permissions are set too loosely on a specific share, which could lead to sensitive data disclosure or other attacks.

```powershell-session
Get-NetShare -ComputerName SQL01

Name             Type Remark        ComputerName
----             ---- ------        ------------
ADMIN$     2147483648 Remote Admin  SQL01
C$         2147483648 Default share SQL01
DB_backups          0               SQL01
IPC$       2147483651 Remote IPC    SQL01
```

```powershell-session
Get-PathAcl "\\SQL01\DB_backups"
```

Aside from ACLs of specific users and computers that may allow us to fully control or grant us other permissions, we should also check the ACL of the domain object. A common attack called [DCSync](https://adsecurity.org/?p=1729) requires a user to be delegated a combination of the following three rights:

- Replicating Directory Changes (DS-Replication-Get-Changes)
- Replicating Directory Changes All (DS-Replication-Get-Changes-All)
- Replicating Directory Changes In Filtered Set (DS-Replication-Get-Changes-In-Filtered-Set)

We can use the `Get-ObjectACL` function to search for all users that have these rights.

```powershell-session
$dcsync = Get-ObjectACL "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ActiveDirectoryRights -match 'GenericAll') -or ($_.ObjectAceType -match 'Replication-Get')} | Select-Object -ExpandProperty SecurityIdentifier | Select -ExpandProperty value

Convert-SidToName $dcsync
```






























