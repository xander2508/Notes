We can use [[PowerView SharpView]], [[Bloodhound]], and [[Group3r]] to enumerate Group Policy security misconfigurations. This section will show some of the enumeration techniques we can perform on the command line using `PowerView` and `SharpView`.

## GPO Abuse

GPOs can be abused to perform attacks such as adding additional rights to a user, adding a local admin, or creating an immediate scheduled task. There are several ways to gain persistence via GPOs:

- Configure a GPO to run any of the above attacks.
- Create a scheduled task to modify group membership, add an account, run DCSync, or send back a reverse shell connection.
- Install targeted malware across the entire Domain.

[[SharpGPOAbuse]] is a tool which can take advantage of GPO misconfigurations.

Gathering GPO names

```powershell-session
Get-DomainGPO | select displayname
```

We can also check which GPOs apply to a specific computer.

```powershell-session
Get-DomainGPO -ComputerName WS01 | select displayname
```

```powershell-session
Get-DomainGPO -Identity "Audit Policy" | select displayname,objectguid
```

Analyzing the GPO names can give us an idea of some of the security configurations in the target domain, such as LAPS, AppLocker, PowerShell Logging, cmd.exe disabled for workstations, etc. We can check for hosts/users that these GPOs are not applied to and plan out our attack paths for circumventing these controls.

If we do not have tools available to us, we can use [gpresult](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/gpresult), which is a built-in tool that determines GPOs that have been applied to a given user or computer and their settings. We can use specific commands to see the GPOs applied to a specific user and computer, respectively, such as:

```cmd-session
gpresult /r /user:harry.jones
```

```cmd-session
gpresult /r /S WS01
```

The tool can output in HTML format with a command such as `gpresult /h gpo_report.html`.

## GPO Permissions

We can use the `Get-DomainGPO` and `Get-ObjectAcl` using the SID for the `Domain Users` group to see if this group has any permissions assigned to any GPOs.

```powershell-session
Get-DomainGPO | Get-ObjectAcl | ? {$_.SecurityIdentifier -eq 'S-1-5-21-2974783224-3764228556-2640795941-513'}

ObjectDN              : CN={831DE3ED-40B1-4703-ABA7-8EA13B2EB118},CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL
ObjectSID             :
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
BinaryLength          : 36
AceQualifier          : AccessAllowed
IsCallback            : False
OpaqueLength          : 0
AccessMask            : 131127
SecurityIdentifier    : S-1-5-21-2974783224-3764228556-2640795941-513
AceType               : AccessAllowed
AceFlags              : ContainerInherit
IsInherited           : False
InheritanceFlags      : ContainerInherit
PropagationFlags      : None
AuditFlags            : None
```

From the result, we can see that one GPO allows all Domain Users full write access. We can then confirm the name of the GPO using the built-in cmdlet `Get-GPO`.

```powershell-session
Get-GPO -Guid 831DE3ED-40B1-4703-ABA7-8EA13B2EB118

DisplayName      : Screensaver
DomainName       : INLANEFREIGHT.LOCAL
Owner            : INLANEFREIGHT\Domain Admins
Id               : 831de3ed-40b1-4703-aba7-8ea13b2eb118
GpoStatus        : AllSettingsEnabled
Description      :
CreationTime     : 8/26/2020 10:46:46 PM
ModificationTime : 8/26/2020 11:11:01 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 0, SysVol Version: 0
WmiFilter        :
```

This misconfigured GPO could be exploited using a tool such as `SharpGPOAbuse` and the `--AddUserRights` attack to give a user unintended rights or the `--AddLocalAdmin` attack to add a user as a local admin on a machine where the GPO is applied and use it to move laterally towards our target.

## Hidden GPO Code Execution Paths

Group Policy is the most basic way System Administrators can command many Computers to perform a task. It is not the most common way to do things as many organizations will use commercial applications such as:

- Microsoft SCCM - System Center Configuration Manager
- PDQInventory/Deploy
- NinjaRMM (Remote Management and Monitoring)
- Ansible/Puppet/Salt

However, each one of these applications is non-default, and when an Administrator googles for a solution, their answer probably won't include the technology they use. Often, you may find one-off configurations an administrator did to accomplish a task quickly. For example, on multiple occasions, I have run across a "Machine/User Startup" script to collect inventory and write it to a domain share. I have seen this policy execute both BAT and VBScript files that were either write-able by the `machine account` or `domain users`. Whenever I dig into file shares and see files write-able by Everyone, Authenticated Users, Domain Users, Domain Computers, etc., containing what looks like log files, I dig into Group Policy, specifically looking for Startup Scripts.

That is just one way an Administrators use "Code Execution via GP" legitimately. Here is a list of the path's I know about:

- Add Registry Autoruns
- Software Installation (Install MSI Package that exists on a share)
- Scripts in the Startup/Shutdown for a Machine or User
- Create Shortcuts on Desktops that point to files
- Scheduled Tasks

If anyone of these paths points to a file on a share, enumerate the permissions to check if non-administrators can edit the file. Your tools will often miss this because it only looks at if the Group Policy itself is write-able, not if the executables/scripts the group policy references are writeable.

























